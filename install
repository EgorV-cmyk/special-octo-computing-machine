#!/bin/sh

PACKAGE=$1
APK_FILE="${PACKAGE}.apk"
APK_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/$APK_FILE"
TMP_DIR="/mnt/external/0/lavender.env/tmp"
ROOTFS="/mnt/external/0"

echo "Скачиваю: $APK_URL"
mkdir -p "$TMP_DIR"
cd "$TMP_DIR" || exit 1
curl -O "$APK_URL" || { echo "Ошибка загрузки $PACKAGE"; exit 1; }

echo "Проверяю содержимое $APK_FILE..."
tar -tf "$APK_FILE" > /dev/null 2>&1 || {
echo "Ошибка: $APK_FILE не является tar-архивом!"
exit 1
}

echo "Распаковываю: $PACKAGE"
tar -xf "$APK_FILE" --warning=no-unknown-keyword -C "$TMP_DIR"

echo "Распределяю файлы..."
[ -d "$TMP_DIR/etc" ] && mv "$TMP_DIR/etc"/* "$ROOTFS/etc/" 2>/dev/null
[ -d "$TMP_DIR/bin" ] && mv "$TMP_DIR/bin"/* "$ROOTFS/bin/" 2>/dev/null
[ -d "$TMP_DIR/sbin" ] && mv "$TMP_DIR/sbin"/* "$ROOTFS/bin/" 2>/dev/null
[ -d "$TMP_DIR/lib" ] && mv "$TMP_DIR/lib"/* "$ROOTFS/lib/" 2>/dev/null

if [ -d "$TMP_DIR/usr" ]; then
[ -d "$TMP_DIR/usr/bin" ] && mv "$TMP_DIR/usr/bin"/* "$ROOTFS/usr/bin/" 2>/dev/null
[ -d "$TMP_DIR/usr/sbin" ] && mv "$TMP_DIR/usr/sbin"/* "$ROOTFS/usr/bin/" 2>/dev/null
[ -d "$TMP_DIR/usr/lib" ] && mv "$TMP_DIR/usr/lib"/* "$ROOTFS/usr/lib/" 2>/dev/null
[ -d "$TMP_DIR/usr/share" ] && mv "$TMP_DIR/usr/share"/* "$ROOTFS/usr/share/" 2>/dev/null
[ -d "$TMP_DIR/usr/libexec" ] && mv "$TMP_DIR/usr/libexec"/* "$ROOTFS/usr/libexec/" 2>/dev/null
fi

echo "Очистка..."
rm -rf "$TMP_DIR"/*

echo "Готово! Установлен пакет: $PACKAGE"
