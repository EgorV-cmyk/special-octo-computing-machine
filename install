#!/bin/sh

PACKAGE=$1

APK_FILE="${PACKAGE}.apk"
APK_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/$APK_FILE"
TMP_DIR="/mnt/external/0/lavender.env/tmp"
ROOTFS="/mnt/external/0"
TRACK_DIR="/mnt/external/0/lavender.env/installed"
TRACK_FILE="$TRACK_DIR/${PACKAGE}.list"

# Цвета
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RESET="\033[0m"

log_info()    { printf "${YELLOW}[!]${RESET} %s\n" "$1"; }
log_success() { printf "${GREEN}[✓]${RESET} %s\n" "$1"; }
log_error()   { printf "${RED}[✗]${RESET} %s\n" "$1"; }

mkdir -p "$TMP_DIR" "$TRACK_DIR"
cd "$TMP_DIR" || { log_error "Failed to cd to $TMP_DIR"; exit 1; }

log_info "Downloading: $APK_URL"
curl -s -O "$APK_URL" || { log_error "Download failed: $PACKAGE"; exit 1; }

log_info "Extracting: $APK_FILE"
tar -xf "$APK_FILE" --warning=no-unknown-keyword -C "$TMP_DIR" || {
    log_error "Failed to extract $APK_FILE"
    exit 1
}

log_info "Installing and tracking..."

copy_and_track() {
    SRC="$1"
    if [ -d "$TMP_DIR/$SRC" ]; then
        find "$TMP_DIR/$SRC" -type f | while read -r FILE; do
            REL_PATH="${FILE#$TMP_DIR/}"
            DEST="$ROOTFS/$REL_PATH"
            mkdir -p "$(dirname "$DEST")"
            cp -a "$FILE" "$DEST"
            echo "/$REL_PATH" >> "$TRACK_FILE"
        done
    fi
}

# Основные каталоги, включая все с либами
for dir in etc bin sbin lib usr/bin usr/sbin usr/lib usr/libexec usr/share usr/share/lib; do
    copy_and_track "$dir"
done

log_info "Cleaning up..."
rm -rf "$TMP_DIR"/*

log_success "Installed: $PACKAGE"
log_info "Tracked in: $TRACK_FILE"
