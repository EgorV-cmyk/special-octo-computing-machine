#!/bin/sh

PACKAGE=$1
echo "3"
APK_FILE="${PACKAGE}.apk"
APK_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/$APK_FILE"
TMP_DIR="/mnt/external/0/lavender.env/tmp"
ROOTFS="/mnt/external/0"
TRACK_DIR="/mnt/external/0/lavender.env/installed"
TRACK_FILE="$TRACK_DIR/${PACKAGE}.list"

# Цвета
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RESET="\033[0m"

log_info()   { printf "${YELLOW}[!]${RESET} %s\n" "$1"; }
log_success(){ printf "${GREEN}[✓]${RESET} %s\n" "$1"; }
log_error()  { printf "${RED}[✗] %s${RESET}\n" "$1"; }

mkdir -p "$TMP_DIR" "$TRACK_DIR"
cd "$TMP_DIR" || { log_error "Не удалось перейти в $TMP_DIR"; exit 1; }

log_info "Скачивание: $APK_URL"
curl -s -O "$APK_URL" || { log_error "Ошибка загрузки $PACKAGE"; exit 1; }

log_info "Проверка содержимого архива..."
tar -tf "$APK_FILE" > /dev/null 2>&1 || {
  log_error "$APK_FILE не является допустимым tar архивом!"
  exit 1
}

log_info "Распаковка пакета: $PACKAGE"
tar -xf "$APK_FILE" --warning=no-unknown-keyword -C "$TMP_DIR"

log_info "Установка файлов и трекинг..."

move_and_track() {
  SRC="$1"
  if [ -d "$TMP_DIR/$SRC" ]; then
    find "$TMP_DIR/$SRC" -type f | while read -r FILE; do
      REL_PATH="${FILE#$TMP_DIR/}"
      DEST_PATH="$ROOTFS/$REL_PATH"
      mkdir -p "$(dirname "$DEST_PATH")"
      mv "$FILE" "$DEST_PATH"
      echo "/$REL_PATH" >> "$TRACK_FILE"
    done
  fi
}

# Основные каталоги
for DIR in etc bin sbin lib usr/bin usr/sbin usr/lib usr/share usr/libexec; do
  move_and_track "$DIR"
done

# Создание симлинков .so -> .so.X или .so.X -> .so.X.Y если нужно
log_info "Создание недостающих симлинков в lib директориях..."
for LIBDIR in lib usr/lib usr/libexec; do
  [ -d "$ROOTFS/$LIBDIR" ] || continue
  cd "$ROOTFS/$LIBDIR" || continue

  for REALFILE in *.so.*.*; do
    [ -f "$REALFILE" ] || continue
    BASE=$(echo "$REALFILE" | sed -E 's/\.so\..*/.so/')
    MAJOR=$(echo "$REALFILE" | sed -E 's/.*\.so\.([0-9]+).*/.so.\1/')
    
    [ -e "$BASE" ]     || ln -s "$REALFILE" "$BASE"
    [ -e "$MAJOR" ]    || ln -s "$REALFILE" "$MAJOR"
  done
done

log_info "Очистка временных файлов..."
rm -rf "$TMP_DIR"/*

log_success "Установлен: $PACKAGE"
log_info "Файл трекинга: $TRACK_FILE"
