#!/bin/sh

PACKAGE=$1
APK_FILE="${PACKAGE}.apk"
APK_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/$APK_FILE"

TMP_DIR="/mnt/external/0/lavender.env/tmp"
ROOTFS="/mnt/external/0"
TRACK_DIR="/mnt/external/0/lavender.env/installed"
TRACK_FILE="$TRACK_DIR/${PACKAGE}.list"

# Цвета
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RESET="\033[0m"

log()   { printf "${YELLOW}[!]${RESET} %s\n" "$1"; }
ok()    { printf "${GREEN}[✓]${RESET} %s\n" "$1"; }
fail()  { printf "${RED}[✗]${RESET} %s\n" "$1"; }

write_path() {
  echo "$1" >> "$TRACK_FILE"
}

install_dir() {
  SRC="$1"
  [ -d "$TMP_DIR/$SRC" ] || return
  find "$TMP_DIR/$SRC" -type f | while read -r FILE; do
    REL="${FILE#$TMP_DIR/}"
    DEST="$ROOTFS/$REL"
    mkdir -p "$(dirname "$DEST")"
    mv "$FILE" "$DEST"
    write_path "/$REL"
  done
}

mkdir -p "$TMP_DIR" "$TRACK_DIR"
cd "$TMP_DIR" || { fail "Не удалось зайти в $TMP_DIR"; exit 1; }

log "Скачиваю: $APK_URL"
curl -s -O "$APK_URL" || { fail "Сбой загрузки: $PACKAGE"; exit 1; }

log "Проверка архива..."
tar -tf "$APK_FILE" > /dev/null 2>&1 || {
  fail "$APK_FILE не является допустимым архивом!"
  exit 1
}

log "Распаковка: $PACKAGE"
tar -xf "$APK_FILE" --warning=no-unknown-keyword -C "$TMP_DIR"

log "Установка и отслеживание файлов..."
for DIR in etc bin sbin usr/bin usr/sbin usr/lib usr/share usr/libexec; do
  install_dir "$DIR"
done

log "Очистка временных файлов..."
rm -rf "$TMP_DIR"/*

ok "Пакет установлен: $PACKAGE"
log "Файл трекинга: $TRACK_FILE"
